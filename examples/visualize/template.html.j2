<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Task Viewer</title>
    <script src="https://unpkg.com/maplibre-gl@^5/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@^5/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        const COLORS = {
          'Default': '#6b7280',
          'Start': '#22c55e',
          'OptionalStart': '#86efac',
          'Finish': '#ef4444',
          'Turn': '#3b82f6',
          'Area': '#eab308'
        };

        const geojson = {{ geojson }};

        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    'osm': {
                        type: 'raster',
                        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }
                },
                layers: [{
                    id: 'osm-tiles',
                    type: 'raster',
                    source: 'osm',
                    minzoom: 0,
                    maxzoom: 19
                }]
            },
            center: [0, 0],
            zoom: 2
        });

        map.on('load', () => {
            map.addSource('task', {
                type: 'geojson',
                data: geojson
            });

            // Observation zone fills
            map.addLayer({
                id: 'zone-fill',
                type: 'fill',
                source: 'task',
                filter: ['==', ['get', 'feature_type'], 'observation_zone'],
                paint: {
                    'fill-color': ['match', ['get', 'point_type'],
                        'Start', COLORS.Start,
                        'OptionalStart', COLORS.OptionalStart,
                        'Finish', COLORS.Finish,
                        'Turn', COLORS.Turn,
                        'Area', COLORS.Area,
                        COLORS.Default
                    ],
                    'fill-opacity': 0.2
                }
            });

            // Observation zone outlines
            map.addLayer({
                id: 'zone-outline',
                type: 'line',
                source: 'task',
                filter: ['==', ['get', 'feature_type'], 'observation_zone'],
                paint: {
                    'line-color': ['match', ['get', 'point_type'],
                        'Start', COLORS.Start,
                        'OptionalStart', COLORS.OptionalStart,
                        'Finish', COLORS.Finish,
                        'Turn', COLORS.Turn,
                        'Area', COLORS.Area,
                        COLORS.Default
                    ],
                    'line-width': ['case',
                        ['==', ['geometry-type'], 'LineString'], 4,
                        2
                    ]
                }
            });

          // Course line
          map.addLayer({
            id: 'course-line',
            type: 'line',
            source: 'task',
            filter: ['==', ['get', 'feature_type'], 'course_line'],
            paint: {
              'line-color': '#374151',
              'line-width': 2,
              'line-dasharray': [4, 2]
            }
          });

            // Waypoint markers
            map.addLayer({
                id: 'waypoints',
                type: 'circle',
                source: 'task',
                filter: ['==', ['get', 'feature_type'], 'waypoint'],
                paint: {
                    'circle-radius': 6,
                    'circle-color': ['match', ['get', 'point_type'],
                        'Start', COLORS.Start,
                        'OptionalStart', COLORS.OptionalStart,
                        'Finish', COLORS.Finish,
                        'Turn', COLORS.Turn,
                        'Area', COLORS.Area,
                        COLORS.Default
                    ],
                    'circle-stroke-color': '#ffffff',
                    'circle-stroke-width': 2
                }
            });

            // Waypoint labels
            map.addLayer({
                id: 'waypoint-labels',
                type: 'symbol',
                source: 'task',
                filter: ['==', ['get', 'feature_type'], 'waypoint'],
                layout: {
                    'text-field': ['get', 'name'],
                    'text-size': 12,
                    'text-offset': [0, -1.5],
                    'text-anchor': 'bottom'
                },
                paint: {
                    'text-color': '#1f2937',
                    'text-halo-color': '#ffffff',
                    'text-halo-width': 1.5
                }
            });

            // Fit map to task bounds
            map.getSource('task').getBounds().then(bounds => {
                map.fitBounds(bounds, { padding: 50 });
            });
        });
    </script>
</body>
</html>
